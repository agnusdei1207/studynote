<!DOCTYPE html>
<html lang="{{ page.lang | default: site.lang | default: 'ko-KR' }}">
{%- include head.html -%}
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a class="site-brand" href="{{ '/' | relative_url }}">
        <div class="logo-icon">S</div>
        <span class="site-title"><span>{{ site.title }}</span></span>
      </a>

      <div class="header-right">
        <div class="search-container">
          <span class="search-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </span>
          <input type="text" class="search-input" id="search-input" placeholder="검색..." autocomplete="off">
          <span class="search-shortcut">/</span>
          <div class="search-results" id="search-results"></div>
        </div>

        <nav class="site-nav">
          <a href="{{ '/' | relative_url }}">home</a>
          <a href="{{ '/cs_fundamentals/' | relative_url }}">cs</a>
          <a href="{{ '/programming/' | relative_url }}">code</a>
          <a href="https://github.com/agnusdei1207/note">github</a>
        </nav>
      </div>
    </div>
  </header>

  <main class="container">
    {{ content }}
  </main>

  <footer class="site-footer">
    <div class="container">
      <div class="footer-inner">
        <div class="footer-section">
          <h4>project</h4>
          <a href="{{ '/' | relative_url }}">home</a>
          <a href="{{ '/cs_fundamentals/' | relative_url }}">cs_fundamentals</a>
          <a href="{{ '/programming/' | relative_url }}">programming</a>
        </div>

        <div class="footer-section">
          <h4>links</h4>
          <a href="https://github.com/agnusdei1207/note">github</a>
          <a href="{{ '/feed.xml' | relative_url }}">rss</a>
          <a href="{{ '/sitemap.xml' | relative_url }}">sitemap</a>
        </div>
      </div>

      <div class="footer-bottom">
        © {{ 'now' | date: "%Y" }} {{ site.author }}
      </div>
    </div>
  </footer>

  <!-- Search Script (XSS-safe) -->
  <script>
  (function() {
    // Escape HTML for safe rendering
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Build search index from all pages
    const searchIndex = [
      {%- for doc in site.html_pages -%}
      {%- if doc.title and doc.title != '홈' -%}
      {
        title: {{ doc.title | jsonify }},
        url: {{ doc.url | relative_url | jsonify }},
        content: {{ doc.content | strip_html | strip_newlines | truncatewords: 100 | jsonify }},
        categories: {{ doc.categories | jsonify }},
        tags: {{ doc.tags | jsonify }}
      },
      {%- endif -%}
      {%- endfor -%}
      {%- for doc in site.documents -%}
      {%- if doc.title and doc.layout == 'post' -%}
      {
        title: {{ doc.title | jsonify }},
        url: {{ doc.url | relative_url | jsonify }},
        content: {{ doc.content | strip_html | strip_newlines | truncatewords: 100 | jsonify }},
        categories: {{ doc.categories | jsonify }},
        tags: {{ doc.tags | jsonify }}
      },
      {%- endif -%}
      {%- endfor -%}
    ];

    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');

    // Focus search on "/" key
    document.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement !== searchInput) {
        e.preventDefault();
        searchInput.focus();
      }
      if (e.key === 'Escape') {
        searchInput.blur();
        searchResults.classList.remove('active');
      }
    });

    // Search function
    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase().trim();

      if (query.length < 2) {
        searchResults.classList.remove('active');
        return;
      }

      const results = searchIndex.filter(item => {
        const titleMatch = item.title.toLowerCase().includes(query);
        const contentMatch = item.content.toLowerCase().includes(query);
        const tagMatch = item.tags && item.tags.some(tag => tag.toLowerCase().includes(query));
        return titleMatch || contentMatch || tagMatch;
      }).slice(0, 10);

      searchResults.textContent = '';

      if (results.length === 0) {
        const noResults = document.createElement('div');
        noResults.className = 'no-results';
        noResults.textContent = '검색 결과가 없습니다';
        searchResults.appendChild(noResults);
      } else {
        results.forEach(item => {
          const link = document.createElement('a');
          link.href = item.url;
          link.className = 'search-result-item';

          const titleDiv = document.createElement('div');
          titleDiv.className = 'result-title';
          titleDiv.textContent = item.title;

          const pathDiv = document.createElement('div');
          pathDiv.className = 'result-path';
          pathDiv.textContent = item.url.replace('{{ site.baseurl }}', '');

          link.appendChild(titleDiv);
          link.appendChild(pathDiv);
          searchResults.appendChild(link);
        });
      }

      searchResults.classList.add('active');
    });

    // Close results when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-container')) {
        searchResults.classList.remove('active');
      }
    });
  })();
  </script>
</body>
</html>
