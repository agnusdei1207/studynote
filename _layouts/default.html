<!DOCTYPE html>
<html lang="{{ page.lang | default: site.lang | default: 'ko-KR' }}">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ page.title }} | {{ site.title }}</title>
  <link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"
    onload="renderMathInElement(document.body);"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
    rel="stylesheet">
</head>

<body data-theme="light">
  <script>
    const theme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    document.body.setAttribute('data-theme', theme);
  </script>

  <header class="site-header">
    <div class="container header-inner">
      <a href="{{ '/' | relative_url }}" class="site-title">{{ site.title }}</a>
      <div class="nav-actions">
        <button class="btn-icon" onclick="openSearch()" title="검색 (/)">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8" />
            <path d="m21 21-4.3-4.3" />
          </svg>
        </button>
        <button class="btn-icon" onclick="toggleTheme()" id="theme-toggle">
          <svg class="sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <circle cx="12" cy="12" r="5" />
            <path
              d="M12 1v2m0 18v2M4.2 4.2l1.4 1.4m12.8 12.8l1.4 1.4M1 12h2m18 0h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4" />
          </svg>
        </button>
      </div>
    </div>
  </header>

  <main class="container" style="padding: 40px 0;">
    {{ content }}
  </main>

  <footer class="site-footer">
    <div class="container">
      <p>© {{ 'now' | date: "%Y" }} {{ site.title }}. Built with Simplicity.</p>
    </div>
  </footer>

  <div id="search-modal" onclick="if(event.target===this) closeSearch()">
    <div class="search-box">
      <div class="search-input-wrapper">
        <input type="text" id="search-input" placeholder="제목이나 내용으로 검색..." autocomplete="off">
      </div>
      <div class="search-results" id="search-results"></div>
    </div>
  </div>

  <script>
    function toggleTheme() {
      const current = document.body.getAttribute('data-theme');
      const next = current === 'light' ? 'dark' : 'light';
      document.body.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    }

    const searchModal = document.getElementById('search-modal');
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');

    const index = [
      {% for page in site.html_pages %}
    { title: { { page.title | jsonify } }, url: { { page.url | relative_url | jsonify } }, content: { { page.content | strip_html | strip_newlines | jsonify } } },
    {% endfor %}
    {% for post in site.posts %}
    { title: { { post.title | jsonify } }, url: { { post.url | relative_url | jsonify } }, content: { { post.content | strip_html | strip_newlines | jsonify } } },
    {% endfor %}
    ];

    function openSearch() {
      searchModal.classList.add('active');
      searchInput.focus();
    }
    function closeSearch() {
      searchModal.classList.remove('active');
      searchInput.value = '';
      searchResults.innerHTML = '';
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === '/' && !searchModal.classList.contains('active')) {
        e.preventDefault();
        openSearch();
      }
      if (e.key === 'Escape') closeSearch();
    });

    searchInput.addEventListener('input', (e) => {
      const q = e.target.value.toLowerCase().trim();
      if (!q) { searchResults.innerHTML = ''; return; }
      const results = index.filter(item =>
        (item.title && item.title.toLowerCase().includes(q)) ||
        (item.content && item.content.toLowerCase().includes(q))
      ).slice(0, 10);

      searchResults.innerHTML = results.map(res => `
        <a href="${res.url}" class="result-item">
          <div class="title">${res.title || 'Untitled'}</div>
          <div class="excerpt">${res.content.substring(0, 120)}...</div>
        </a>
      `).join('');
    });
  </script>
</body>

</html>