+++
title = "세마포어 (Semaphore)"
date = 2025-02-27
+++

# 세마포어 (Semaphore)

## 핵심 인사이트 (3줄 요약)
> **공유 자원 접근을 제어**하는 동기화 메커니즘. 카운터로 사용 가능한 자원 수를 관리하며, P(wait)와 V(signal) 연산으로 제어한다. 멀티스레딩에서 경쟁 조건을 방지한다.

## 1. 개념
세마포어(Semaphore)는 **여러 프로세스/스레드가 공유 자원에 접근하는 순서를 제어**하는 동기화 도구다. 정수 카운터와 두 가지 연산으로 구성된다.

> 비유: "주차장 빈 자리 표시판" - 자리가 있어야 들어갈 수 있음

## 2. 세마포어 연산

```
P(wait) 연산:
if (counter > 0) {
    counter--;
    // 자원 사용
} else {
    // 대기
}

V(signal) 연산:
counter++;
// 대기 중인 프로세스 깨움
```

## 3. 세마포어 종류

### 이진 세마포어 (Binary Semaphore)
```
값: 0 또는 1
용도: 상호 배제 (Mutex)

초기값: 1
P() → 0 (자원 획득)
V() → 1 (자원 해제)
```

### 카운팅 세마포어 (Counting Semaphore)
```
값: 0 이상의 정수
용도: 제한된 자원 관리

초기값: N (자원 개수)
예: 프린터 3대 → 초기값 3
```

## 4. 동작 예시

```
주차장 (세마포어 초기값 = 3):

차량1 진입: P() → counter=2, 진입 ✅
차량2 진입: P() → counter=1, 진입 ✅
차량3 진입: P() → counter=0, 진입 ✅
차량4 진입: P() → counter=0, 대기 ⏳
차량2 출차: V() → counter=1, 차량4 진입 ✅
```

## 5. 상호 배제 (Mutual Exclusion)

```
공유 변수 보호:

Semaphore mutex = 1;

// 스레드 1
P(mutex);        // 잠금
x = x + 1;       // 임계 영역
V(mutex);        // 해제

// 스레드 2
P(mutex);        // 잠금 (스레드 1이 끝날 때까지 대기)
x = x + 1;       // 임계 영역
V(mutex);        // 해제
```

## 6. 세마포어 vs 뮤텍스

| 특징 | 세마포어 | 뮤텍스 |
|------|----------|--------|
| 값 | 0 이상 정수 | 0 또는 1 |
| 소유권 | 없음 | 있음 |
| 해제 | 누구나 | 소유자만 |
| 용도 | 자원 관리 | 상호 배제 |

## 7. 생산자-소비자 문제

```c
Semaphore empty = N;  // 빈 버퍼 수
Semaphore full = 0;   // 찬 버퍼 수
Semaphore mutex = 1;  // 상호 배제

// 생산자
void producer() {
    while(1) {
        item = produce();
        P(empty);  // 빈 공간 있나?
        P(mutex);  // 버퍼 잠금
        buffer[in] = item;
        in = (in + 1) % N;
        V(mutex);  // 버퍼 해제
        V(full);   // 찬 공간 증가
    }
}

// 소비자
void consumer() {
    while(1) {
        P(full);   // 데이터 있나?
        P(mutex);  // 버퍼 잠금
        item = buffer[out];
        out = (out + 1) % N;
        V(mutex);  // 버퍼 해제
        V(empty);  // 빈 공간 증가
        consume(item);
    }
}
```

## 8. 데드락

```
데드락 상황:
프로세스 A: P(S1) → P(S2)
프로세스 B: P(S2) → P(S1)

A가 S1 보유, B가 S2 보유
서로 상대방 자원 기다림 → 교착!

해결:
- 자원 할당 순서 통일
- 타임아웃
- 데드락 탐지/복구
```

## 9. 코드 예시

```c
#include <semaphore.h>

sem_t sem;

void init() {
    sem_init(&sem, 0, 3);  // 초기값 3
}

void use_resource() {
    sem_wait(&sem);   // P 연산
    // 자원 사용
    sem_post(&sem);   // V 연산
}
```

## 10. 장단점

| 장점 | 단점 |
|-----|------|
| 유연한 자원 관리 | 데드락 위험 |
| 간단한 인터페이스 | 우선순위 역전 가능 |
| 다양한 동기화 | 디버깅 어려움 |

## 11. 실무에선? (기술사적 판단)
- **데이터베이스**: 연결 풀 관리
- **스레드 풀**: 작업 큐 동기화
- **임베디드**: RTOS 태스크 동기화
- **Linux**: POSIX 세마포어

## 12. 관련 개념
- 뮤텍스 (Mutex)
- 모니터 (Monitor)
- 데드락 (Deadlock)

---

## 어린이를 위한 종합 설명

**세마포어는 "주차장 표시판"이야!**

### 주차장 예시
```
주차장: 3자리

표시판: [3] → [2] → [1] → [0] (꽉 참!)

차 들어갈 때: P() - 1
차 나올 때: V() + 1

0이면? 기다려야 해요! 🚗💨
```

### 화장실 열쇠 비유
```
화장실 열쇠가 1개야!

사람1: 열쇠 가져감 (P) → 화장실 사용
사람2: 열쇠 없음... 대기 ⏳
사람1: 열쇠 반납 (V)
사람2: 열쇠 획득! (P) → 화장실 사용
```

### 세마포어 vs 뮤텍스
```
세마포어: 열쇠가 여러 개 (주차장)
뮤텍스: 열쇠가 1개 (화장실)
```

**비밀**: 많은 사람이 같은 걸 쓰려고 할 때, 순서를 정해주는 교통경찰이에요! 🚦
