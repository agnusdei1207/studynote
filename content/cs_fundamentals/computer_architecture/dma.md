# 직접 메모리 접근 (DMA, Direct Memory Access)

## 핵심 인사이트 (3줄 요약)
> CPU 개입 없이 **장치가 직접 메모리에 접근**하여 데이터를 전송하는 기술. CPU 부하를 줄이고 전송 효율을 높인다. 대량 데이터 전송(오디오, 비디오, 네트워크)에 필수적이다.

## 1. 개념
DMA(Direct Memory Access)는 **CPU를 거치지 않고 입출력 장치가 메모리와 직접 데이터를 주고받는** 기술이다. DMA 컨트롤러가 전송을 관리한다.

> 비유: "택배 직접 배송" - 중간 사람(CPU) 없이 바로 배송

## 2. DMA 없는 전송 (PIO)

```
CPU가 모든 전송 관리:

장치 → CPU → 메모리
장치 ← CPU ← 메모리

문제점:
- CPU가 전송마다 개입
- CPU가 다른 일 못 함
- 대량 전송에 비효율
```

## 3. DMA 전송

```
DMA 컨트롤러가 전송 관리:

         ┌──────────┐
장치 ←──→│   DMA    │←──→ 메모리
         │컨트롤러  │
         └──────────┘
              │
              ↓ (완료 알림만)
            CPU

장점:
- CPU는 다른 일 가능
- 고속 전송 가능
- 버스트 모드 지원
```

## 4. DMA 전송 과정

```
1. CPU가 DMA 설정
   - 소스 주소
   - 목적지 주소
   - 전송 크기
   - 전송 방향

2. DMA 시작

3. DMA 컨트롤러가 전송 수행
   (CPU는 다른 작업 수행)

4. 전송 완료 시 인터럽트

5. CPU가 완료 확인
```

## 5. DMA 전송 모드

| 모드 | 설명 | 용도 |
|------|------|------|
| 바이트 | 1바이트마다 버스 요청 | 저속 장치 |
| 버스트 | 연속 전송 후 버스 반환 | 고속 전송 |
| 사이클 스틸링 | CPU 사이클 훔쳐서 사용 | 균형 |

## 6. Cycle Stealing

```
버스 사용 타임라인:

CPU: [====][====][====][====]
DMA:    [==]   [==]   [==]

→ DMA가 CPU 버스 사이클을 "훔쳐서" 사용

장점: CPU와 DMA가 병행 가능
단점: CPU가 약간 느려짐
```

## 7. DMA 컨트롤러 구조

```
┌────────────────────────────┐
│       DMA Controller       │
│  ┌──────┐  ┌──────┐       │
│  │주소  │  │카운터│       │
│  │레지스터│  │      │       │
│  └──────┘  └──────┘       │
│  ┌──────────────────┐     │
│  │   제어 로직       │     │
│  └──────────────────┘     │
└────────────────────────────┘
        │           │
      메모리       장치
```

## 8. DMA 응용 분야

| 분야 | 용도 |
|------|------|
| 오디오 | I2S → 메모리 |
| 비디오 | 카메라 → 메모리 |
| 네트워크 | 패킷 송수신 |
| 저장장치 | 디스크 I/O |

## 9. 코드 예시 (STM32)

```c
// DMA 설정 예시
void DMA_Config(void) {
    // DMA 스트림 설정
    DMA1_Stream0->PAR = (uint32_t)&USART1->DR;  // 소스: UART
    DMA1_Stream0->M0AR = (uint32_t)buffer;      // 목적지: 메모리
    DMA1_Stream0->NDTR = BUFFER_SIZE;           // 전송 크기

    // 방향: Peripheral → Memory
    DMA1_Stream0->CR |= DMA_SxCR_DIR_0;

    // DMA 활성화
    DMA1_Stream0->CR |= DMA_SxCR_EN;
}

// DMA 완료 인터럽트
void DMA1_Stream0_IRQHandler(void) {
    if (DMA1->LISR & DMA_LISR_TCIF0) {
        // 전송 완료
        DMA1->LIFCR = DMA_LIFCR_CTCIF0;  // 플래그 클리어
    }
}
```

## 10. 장단점

| 장점 | 단점 |
|-----|------|
| CPU 부하 감소 | 하드웨어 복잡 |
| 고속 전송 | 버스 경합 |
| 전력 효율 | 캐시 일관성 문제 |

## 11. 실무에선? (기술사적 판단)
- **오디오/비디오**: 필수 (실시간 스트리밍)
- **네트워크**: 고속 패킷 처리
- **SSD**: 대량 데이터 전송
- **AI**: 가속기-메모리 간 데이터 이동

## 12. 관련 개념
- PIO (Programmed I/O)
- 버스 중재
- 캐시 일관성

---

## 어린이를 위한 종합 설명

**DMA는 "전문 배달부"야!**

### DMA 없이 (PIO)
```
택배가 오면:
1. 택배 기사 → 주인(CPU)에게 전달
2. 주인이 창고(메모리)로 옮김
3. 또 택배가 오면... 반복

→ 주인이 너무 바빠요! 😓
```

### DMA 사용
```
전문 배달부(DMA) 고용:
1. 택배 기사 → 배달부(DMA)가 창고로 바로 옮김
2. 주인(CPU)은 다른 일 함
3. 다 옮기면 "완료!" 알림

→ 주인이 한가해요! ✨
```

### Cycle Stealing (살짝 훔치기)
```
주인: [일][일][일][일]
배달부:  [옮][ ][옮][ ]

→ 주인이 안 쓰는 틈에 살짝 훔쳐서 옮겨요!
```

**비밀**: 음악 들으면서 게임할 수 있는 이유가 DMA 덕분이에요! 음악 데이터는 DMA가 알아서 옮겨주니까요! 🎵🎮
